<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Check In Kiosk v2.2.0</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    :root {
      --bg-dark: #121212;
      --card-bg: #1e1e1e;
      --input-bg: #2d2d2d;
      --border: #333;
      --text: #e0e0e0;
      --text-secondary: #bbbbbb;
      --text-muted: #999;
      --red-bg: #4a1a1a;
      --red-text: #ff6b6b;
      --blue-select: #339af0;
      --success: #28a745;
      --primary: #0d6efd;
      --primary-hover: #0b5ed7;
      --success-hover: #218838;
      --table-header-bg: #2a2a2a;
      --table-header-text: #e0e0e0;
      --input-border: #444;
      --input-focus-bg: #333;
      --input-focus-border: var(--primary);
      --input-focus-shadow: rgba(13, 110, 253, 0.25);
      --logo-url: none;
      --logo-display: none;
    }

    body { 
      background: var(--bg-dark); 
      color: var(--text); 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      min-height: 100vh;
      margin: 0;
    }

    .main-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      padding: 1.5rem;
      margin: 1rem;
      display: flex;
      flex-direction: column;
    }

    @media (min-width: 769px) {
      .main-card { max-width: 1200px; margin: 2rem auto; }
    }

    .form-control, .form-select {
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      color: var(--text);
      border-radius: 8px;
    }
    .form-control:focus, .form-select:focus {
      background: var(--input-focus-bg);
      border-color: var(--input-focus-border);
      box-shadow: 0 0 0 0.2rem var(--input-focus-shadow);
      color: var(--text);
    }

    .btn-primary { background: var(--primary); border: none; }
    .btn-success { background: var(--success); border: none; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-success:hover { background: var(--success-hover); }

    /* STATUS BAR */
    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 1rem 0 0.5rem 0;
      min-height: 2rem;
    }
    .status { 
      font-weight: 600; 
      padding: 0.25rem 0;
      flex: 1;
    }

    /* TABLE CONTAINER */
    .table-container {
      flex: 1;
      max-height: 60vh;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin: 0.5rem 0;
    }

    @media (max-width: 768px) {
      .table-container { max-height: 55vh; }
    }

    .table { 
      font-size: 0.9em; 
      margin-bottom: 0;
    }
    .table th { 
      position: sticky; 
      top: 0; 
      background: var(--table-header-bg); 
      z-index: 5;
      color: var(--table-header-text) !important;
    }

    /* ROW STYLES */
    .red-row td { 
      color: var(--red-text) !important; 
      font-weight: bold !important;
    }
    .selected-row td { 
      background-color: var(--blue-select) !important; 
      color: white !important; 
      font-weight: bold !important;
    }

    /* STICKY FOOTER */
    .footer {
      position: sticky;
      bottom: 0;
      background: var(--card-bg);
      padding: 1rem;
      border-top: 1px solid var(--border);
      z-index: 10;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    @media (max-width: 768px) {
      .main-card { 
        min-height: 100vh; 
        margin: 0; 
        border-radius: 0;
        padding-bottom: 5rem;
      }
      .footer { 
        position: fixed; 
        bottom: 0; 
        left: 0; 
        right: 0; 
        border-radius: 0;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
      }
    }

    .form-label { color: var(--text-secondary); font-weight: 600; }
    small { color: var(--text-muted); }
    h2 { color: var(--primary); }
    
    /* THEME SELECTOR */
    .theme-selector-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      color: var(--text);
      padding: 0;
      cursor: pointer;
      font-size: 1.5rem;
      z-index: 1000;
      transition: opacity 0.2s;
    }
    .theme-selector-btn:hover {
      opacity: 0.7;
    }
    
    /* LOGO */
    .theme-logo {
      display: var(--logo-display);
      max-height: 60px;
      max-width: 200px;
      margin: 0 auto 1rem;
      object-fit: contain;
    }
    
    .header-with-logo {
      position: relative;
    }

    /* HIDDEN UNTIL AUTH */
    #mainUI { display: none; }

    /* ORG INPUT SIZE */
    #org {
      width: 250px;
      max-width: 100%;
    }

    /* MODAL */
    .modal-content {
      background-color: var(--card-bg);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .modal-header, .modal-footer {
      border-color: var(--border);
    }
  </style>
</head>
<body>
  <div class="main-card">
    <button class="theme-selector-btn" id="themeSelectorBtn" title="Select Theme">
      <i class="fas fa-cog"></i>
    </button>
    <div class="header-with-logo">
      <img id="themeLogo" class="theme-logo" alt="Theme Logo" />
      <h2 class="text-center mb-4">Check In Kiosk v2.2.0</h2>
    </div>

    <!-- ORG -->
    <div class="mb-3">
      <label class="form-label">ORG:</label>
      <input type="text" id="org" class="form-control" placeholder="Enter ORG" maxlength="20" />
      <small>Press Enter to authenticate</small>
    </div>

    <!-- MAIN UI (Hidden until auth) -->
    <div id="mainUI">
      <!-- CRITERIA BELOW ORG -->
      <div class="mb-3">
        <label class="form-label">Appointment Criteria:</label>
        <input type="text" id="criteria" class="form-control" placeholder="Appt ID, Carrier, Trailer, or BOL" />
        <small>Search by Appointment ID, Carrier, Trailer, or BOL (space, comma, semicolon, or new line)</small>
      </div>

      <!-- STATUS + FIND BUTTON -->
      <div class="status-bar">
        <div class="status" id="status">Enter ORG and press Enter to authenticate</div>
        <button id="findBtn" class="btn btn-primary px-4">Find Appointment</button>
      </div>

      <!-- SCROLLABLE TABLE -->
      <div class="table-container">
        <table class="table table-dark table-hover" id="resultsTable">
          <thead>
            <tr>
              <th>Appt ID</th>
              <th>Carrier</th>
              <th>BOL</th>
              <th>Trailer</th>
              <th>Equip</th>
              <th>Type</th>
              <th>Scheduled</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- STICKY FOOTER -->
      <div class="footer">
        <div><strong>Selected:</strong> <span id="selected">None</span></div>
        <button id="checkinBtn" class="btn btn-success" disabled>Check In</button>
      </div>
    </div>
  </div>

  <!-- MISSING INFO MODAL -->
  <div class="modal fade" id="missingInfoModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-warning">Missing Information</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Please complete the required fields:</p>
          <div id="missingFields"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="submitMissingBtn">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SUCCESS MODAL -->
  <div class="modal fade" id="checkinModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-success">Check In Complete</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="checkinMessage"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- THEME SELECTOR MODAL -->
  <div class="modal fade" id="themeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Select Theme</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="list-group" id="themeList"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const orgInput = document.getElementById('org');
    const mainUI = document.getElementById('mainUI');
    const criteriaInput = document.getElementById('criteria');
    const findBtn = document.getElementById('findBtn');
    const resultsBody = document.querySelector('#resultsTable tbody');
    const statusEl = document.getElementById('status');
    const selectedEl = document.getElementById('selected');
    const checkinBtn = document.getElementById('checkinBtn');
    const missingInfoModal = new bootstrap.Modal(document.getElementById('missingInfoModal'));
    const checkinModal = new bootstrap.Modal(document.getElementById('checkinModal'));
    const missingFieldsContainer = document.getElementById('missingFields');
    const submitMissingBtn = document.getElementById('submitMissingBtn');
    const checkinMessage = document.getElementById('checkinMessage');
    const themeSelectorBtn = document.getElementById('themeSelectorBtn');
    const themeModal = new bootstrap.Modal(document.getElementById('themeModal'));
    const themeList = document.getElementById('themeList');
    const themeLogo = document.getElementById('themeLogo');

    let token = null;
    let selectedAppt = null;
    let pendingCheckIn = null;

    // THEME DEFINITIONS
    const themes = {
      'default': {
        name: 'Default (Dark)',
        colors: {
          '--bg-dark': '#121212',
          '--card-bg': '#1e1e1e',
          '--input-bg': '#2d2d2d',
          '--border': '#333',
          '--text': '#e0e0e0',
          '--text-secondary': '#bbbbbb',
          '--text-muted': '#999',
          '--red-bg': '#4a1a1a',
          '--red-text': '#ff6b6b',
          '--blue-select': '#339af0',
          '--success': '#28a745',
          '--primary': '#0d6efd',
          '--primary-hover': '#0b5ed7',
          '--success-hover': '#218838',
          '--table-header-bg': '#2a2a2a',
          '--table-header-text': '#e0e0e0',
          '--input-border': '#444',
          '--input-focus-bg': '#333',
          '--input-focus-border': '#0d6efd',
          '--input-focus-shadow': 'rgba(13, 110, 253, 0.25)',
          '--logo-url': 'none',
          '--logo-display': 'none'
        },
        logo: null
      },
      'loves': {
        name: "Love's Travel Stops",
        colors: {
          '--bg-dark': '#f8f9fa',
          '--card-bg': '#ffffff',
          '--input-bg': '#f5f5f5',
          '--border': '#dee2e6',
          '--text': '#212529',
          '--text-secondary': '#495057',
          '--text-muted': '#6c757d',
          '--red-bg': '#fff5f5',
          '--red-text': '#dc3545',
          '--blue-select': '#0056b3',
          '--success': '#28a745',
          '--primary': '#E31837',
          '--primary-hover': '#C0142D',
          '--success-hover': '#218838',
          '--table-header-bg': '#E31837',
          '--table-header-text': '#ffffff',
          '--input-border': '#ced4da',
          '--input-focus-bg': '#ffffff',
          '--input-focus-border': '#E31837',
          '--input-focus-shadow': 'rgba(227, 24, 55, 0.25)',
          '--logo-url': 'url("/loves-logo.png")',
          '--logo-display': 'block'
        },
        logo: '/loves-logo.png'
      },
      'manhattan': {
        name: 'Manhattan Associates',
        colors: {
          '--bg-dark': '#f5f7fa',
          '--card-bg': '#ffffff',
          '--input-bg': '#f0f2f5',
          '--border': '#e1e8ed',
          '--text': '#1a1a1a',
          '--text-secondary': '#4a5568',
          '--text-muted': '#718096',
          '--red-bg': '#fff5f5',
          '--red-text': '#e53e3e',
          '--blue-select': '#3182ce',
          '--success': '#38a169',
          '--primary': '#0066cc',
          '--primary-hover': '#0052a3',
          '--success-hover': '#2f855a',
          '--table-header-bg': '#0066cc',
          '--table-header-text': '#ffffff',
          '--input-border': '#cbd5e0',
          '--input-focus-bg': '#ffffff',
          '--input-focus-border': '#0066cc',
          '--input-focus-shadow': 'rgba(0, 102, 204, 0.25)',
          '--logo-url': 'url("/manhattan-logo.png")',
          '--logo-display': 'block'
        },
        logo: '/manhattan-logo.png'
      },
      'msc': {
        name: 'MSC Industrial Supply',
        colors: {
          '--bg-dark': '#fafafa',
          '--card-bg': '#ffffff',
          '--input-bg': '#f0f0f0',
          '--border': '#e0e0e0',
          '--text': '#1a1a1a',
          '--text-secondary': '#4a4a4a',
          '--text-muted': '#757575',
          '--red-bg': '#ffebee',
          '--red-text': '#c62828',
          '--blue-select': '#1976d2',
          '--success': '#388e3c',
          '--primary': '#003d82',
          '--primary-hover': '#002d5f',
          '--success-hover': '#2e7d32',
          '--table-header-bg': '#003d82',
          '--table-header-text': '#ffffff',
          '--input-border': '#bdbdbd',
          '--input-focus-bg': '#ffffff',
          '--input-focus-border': '#003d82',
          '--input-focus-shadow': 'rgba(0, 61, 130, 0.25)',
          '--logo-url': 'url("/msc-logo.png")',
          '--logo-display': 'block'
        },
        logo: '/msc-logo.png'
      },
      'light': {
        name: 'Light Theme',
        colors: {
          '--bg-dark': '#f8f9fa',
          '--card-bg': '#ffffff',
          '--input-bg': '#f5f5f5',
          '--border': '#dee2e6',
          '--text': '#212529',
          '--text-secondary': '#495057',
          '--text-muted': '#6c757d',
          '--red-bg': '#fff5f5',
          '--red-text': '#dc3545',
          '--blue-select': '#0056b3',
          '--success': '#28a745',
          '--primary': '#0d6efd',
          '--primary-hover': '#0b5ed7',
          '--success-hover': '#218838',
          '--table-header-bg': '#6c757d',
          '--table-header-text': '#ffffff',
          '--input-border': '#ced4da',
          '--input-focus-bg': '#ffffff',
          '--input-focus-border': '#0d6efd',
          '--input-focus-shadow': 'rgba(13, 110, 253, 0.25)',
          '--logo-url': 'none',
          '--logo-display': 'none'
        },
        logo: null
      },
      'corporate-blue': {
        name: 'Corporate Blue',
        colors: {
          '--bg-dark': '#e3f2fd',
          '--card-bg': '#ffffff',
          '--input-bg': '#f5f5f5',
          '--border': '#90caf9',
          '--text': '#1565c0',
          '--text-secondary': '#1976d2',
          '--text-muted': '#64b5f6',
          '--red-bg': '#ffebee',
          '--red-text': '#c62828',
          '--blue-select': '#0d47a1',
          '--success': '#2e7d32',
          '--primary': '#1565c0',
          '--primary-hover': '#0d47a1',
          '--success-hover': '#1b5e20',
          '--table-header-bg': '#1565c0',
          '--table-header-text': '#ffffff',
          '--input-border': '#90caf9',
          '--input-focus-bg': '#ffffff',
          '--input-focus-border': '#1565c0',
          '--input-focus-shadow': 'rgba(21, 101, 192, 0.25)',
          '--logo-url': 'none',
          '--logo-display': 'none'
        },
        logo: null
      }
    };

    // THEME FUNCTIONS
    function applyTheme(themeKey) {
      const theme = themes[themeKey];
      if (!theme) return;

      const root = document.documentElement;
      Object.entries(theme.colors).forEach(([property, value]) => {
        root.style.setProperty(property, value);
      });

      // Update logo
      if (theme.logo) {
        themeLogo.src = theme.logo;
        themeLogo.style.display = 'block';
      } else {
        themeLogo.style.display = 'none';
      }

      // Update table class for light themes
      const table = document.getElementById('resultsTable');
      if (themeKey === 'default') {
        table.className = 'table table-dark table-hover';
      } else {
        table.className = 'table table-hover';
      }

      // Save to localStorage
      localStorage.setItem('selectedTheme', themeKey);
    }

    function loadTheme() {
      const savedTheme = localStorage.getItem('selectedTheme') || 'default';
      applyTheme(savedTheme);
    }

    function renderThemeList() {
      themeList.innerHTML = '';
      const currentTheme = localStorage.getItem('selectedTheme') || 'default';
      
      Object.entries(themes).forEach(([key, theme]) => {
        const item = document.createElement('button');
        item.type = 'button';
        item.className = `list-group-item list-group-item-action ${key === currentTheme ? 'active' : ''}`;
        item.textContent = theme.name;
        item.onclick = () => {
          applyTheme(key);
          themeModal.hide();
        };
        themeList.appendChild(item);
      });
    }

    // Theme selector button
    themeSelectorBtn.onclick = () => {
      renderThemeList();
      themeModal.show();
    };

    // Load theme on page load
    window.addEventListener('load', () => {
      loadTheme();
      api('app_opened', { org: '' });
      orgInput.focus();
    });

    // DROPDOWN CONFIG
    const APPOINTMENT_TYPES = [
      { value: "", label: "— Select Type —" },
      { value: "DROP_UNLOAD", label: "Drop Unload" },
      { value: "LIVE_UNLOAD", label: "Live Unload" },
      { value: "DROP_LOAD", label: "Drop Load" },
      { value: "EMPTY", label: "Empty" }
    ].sort((a, b) => a.label.localeCompare(b.label));

    const EQUIPMENT_TYPES = [
      { value: "", label: "— Select Equip —" },
      { value: "48FT", label: "48FT" },
      { value: "53FT", label: "53FT" },
      { value: "REEFER", label: "Reefer" },
      { value: "FLATBED", label: "Flatbed" }
    ];

    // STATUS
    function status(text, type = 'info') {
      statusEl.textContent = text;
      statusEl.className = `status text-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'}`;
    }

    // API
    async function api(action, data = {}) {
      const headers = { 'Content-Type': 'application/json' };
      if (token) headers.Authorization = `Bearer ${token}`;
      return fetch(`/api/${action}`, {
        method: 'POST',
        headers,
        body: JSON.stringify(data)
      }).then(r => r.json());
    }


    // Auth
    orgInput.addEventListener('keypress', async e => {
      if (e.key !== 'Enter') return;
      const org = orgInput.value.trim();
      if (!org) return status('ORG required', 'error');
      
      // Track auth attempt in Statsig
      if (window.StatsigTracking && window.StatsigTracking.isInitialized()) {
        window.StatsigTracking.logEvent('auth_attempt', {
          org: org,
          timestamp: new Date().toISOString()
        });
      }
      
      status('Authenticating...');
      const res = await api('auth', { org });
      if (!res.success) {
        // Track auth failure in Statsig
        if (window.StatsigTracking && window.StatsigTracking.isInitialized()) {
          window.StatsigTracking.logEvent('auth_failed', {
            org: org,
            error: res.error || 'Auth failed',
            timestamp: new Date().toISOString()
          });
        }
        return status(res.error || 'Auth failed', 'error');
      }
      
      token = res.token;
      status('Authenticated – ready!', 'success');
      
      // Track auth success in Statsig
      if (window.StatsigTracking && window.StatsigTracking.isInitialized()) {
        window.StatsigTracking.logEvent('auth_success', {
          org: org,
          timestamp: new Date().toISOString()
        });
      }
      
      mainUI.style.display = 'block';
      setTimeout(() => criteriaInput.focus(), 100);
    });

    // Enter → Search
    criteriaInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') findBtn.click();
    });

    // Find
    findBtn.onclick = async () => {
      const criteria = criteriaInput.value.trim();
      if (!criteria) return status('Enter criteria', 'error');
      
      // Track search attempt in Statsig
      if (window.StatsigTracking && window.StatsigTracking.isInitialized()) {
        window.StatsigTracking.logEvent('search_attempt', {
          org: orgInput.value.trim() || 'unknown',
          criteria_length: String(criteria.length),
          timestamp: new Date().toISOString()
        });
      }
      
      status('Searching appointments...');
      const res = await api('search', { org: orgInput.value.trim(), criteria, token });
      if (!res.success) {
        // Track search failure in Statsig
        if (window.StatsigTracking && window.StatsigTracking.isInitialized()) {
          window.StatsigTracking.logEvent('search_failed', {
            org: orgInput.value.trim() || 'unknown',
            error: res.error || 'Search failed',
            timestamp: new Date().toISOString()
          });
        }
        return status('Search failed', 'error');
      }
      
      renderResults(res.results);
      showDetailedCount(res.results.length, res.per_criteria);
      
      // Track search success in Statsig
      if (window.StatsigTracking && window.StatsigTracking.isInitialized()) {
        window.StatsigTracking.logEvent('search_completed', {
          org: orgInput.value.trim() || 'unknown',
          results_count: String(res.results.length),
          timestamp: new Date().toISOString()
        });
      }
    };

    // DETAILED COUNT
    function showDetailedCount(total, perCriteria) {
      if (!perCriteria || Object.keys(perCriteria).length === 0) {
        status(`Found ${total} appointments`, 'success');
        return;
      }

      const parts = Object.entries(perCriteria)
        .filter(([crit, count]) => count > 0)
        .sort((a, b) => b[1] - a[1])
        .map(([crit, count]) => `${count} for ${crit}`)
        .join(', ');

      status(`Found ${total} appointments (${parts})`, 'success');
    }

    // Render
    function renderResults(results) {
      resultsBody.innerHTML = '';
      results.sort((a, b) => (a.AppointmentId || '').localeCompare(b.AppointmentId || ''));
      results.forEach(appt => {
        const row = document.createElement('tr');
        row.dataset.appt = JSON.stringify(appt);
        if (appt.AppointmentStatusId !== '3000') row.classList.add('red-row');
        
        // Extract BOL from AppointmentContents
        let bol = '—';
        if (appt.AppointmentContents) {
          if (Array.isArray(appt.AppointmentContents) && appt.AppointmentContents.length > 0) {
            bol = appt.AppointmentContents[0].BillOfLadingNumber || '—';
          } else if (appt.AppointmentContents.BillOfLadingNumber) {
            bol = appt.AppointmentContents.BillOfLadingNumber;
          }
        }
        
        row.innerHTML = `
          <td>${appt.AppointmentId || '—'}</td>
          <td>${appt.CarrierId || '—'}</td>
          <td>${bol}</td>
          <td>${appt.TrailerId || '—'}</td>
          <td>${appt.EquipmentTypeId || '—'}</td>
          <td>${(appt.AppointmentTypeId || '').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</td>
          <td>${appt.ScheduledDate || '—'}</td>
          <td>${appt.StatusText || '—'}</td>
        `;
        row.onclick = () => selectRow(row, appt);
        resultsBody.appendChild(row);
      });
    }

    // Selection
    function selectRow(row, appt) {
      document.querySelectorAll('tr').forEach(r => r.classList.remove('selected-row'));
      row.classList.add('selected-row');
      selectedAppt = appt;
      selectedEl.textContent = appt.AppointmentId || '—';
      checkinBtn.disabled = appt.AppointmentStatusId !== '3000';
    }

    // Check In
    checkinBtn.onclick = async () => {
      if (!selectedAppt || selectedAppt.AppointmentStatusId !== '3000') return;

      const missing = [];
      if (!selectedAppt.CarrierId) missing.push({ field: 'CarrierId', type: 'text', label: 'Carrier' });
      if (!selectedAppt.TrailerId) missing.push({ field: 'TrailerId', type: 'text', label: 'Trailer ID' });
      if (!selectedAppt.AppointmentTypeId) missing.push({ field: 'AppointmentTypeId', type: 'dropdown', label: 'Appointment Type', options: APPOINTMENT_TYPES });
      if (!selectedAppt.EquipmentTypeId) missing.push({ field: 'EquipmentTypeId', type: 'dropdown', label: 'Equipment Type', options: EQUIPMENT_TYPES });

      if (missing.length === 0) {
        await performCheckIn(selectedAppt);
        return;
      }

      pendingCheckIn = { ...selectedAppt };
      renderMissingFields(missing);
      missingInfoModal.show();
    };

    // Render missing fields
    function renderMissingFields(fields) {
      missingFieldsContainer.innerHTML = '';
      fields.forEach(f => {
        const div = document.createElement('div');
        div.className = 'mb-3';

        const label = document.createElement('label');
        label.className = 'form-label';
        label.textContent = f.label + ':';
        div.appendChild(label);

        if (f.type === 'text') {
          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'form-control';
          input.value = selectedAppt[f.field] || '';
          input.dataset.field = f.field;
          div.appendChild(input);
        } else if (f.type === 'dropdown') {
          const select = document.createElement('select');
          select.className = 'form-select';
          select.dataset.field = f.field;
          f.options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.value;
            option.textContent = opt.label;
            if (selectedAppt[f.field] === opt.value) option.selected = true;
            select.appendChild(option);
          });
          div.appendChild(select);
        }

        missingFieldsContainer.appendChild(div);
      });
    }

    // Submit missing info
    submitMissingBtn.onclick = () => {
      const inputs = missingFieldsContainer.querySelectorAll('input, select');
      inputs.forEach(input => {
        pendingCheckIn[input.dataset.field] = input.value.trim();
      });

      missingInfoModal.hide();
      performCheckIn(pendingCheckIn);
    };

    // Perform check-in
    async function performCheckIn(appt) {
      // Track check-in attempt in Statsig
      if (window.StatsigTracking && window.StatsigTracking.isInitialized()) {
        window.StatsigTracking.logEvent('checkin_attempt', {
          org: orgInput.value.trim() || 'unknown',
          appointment_id: appt.AppointmentId || 'unknown',
          timestamp: new Date().toISOString()
        });
      }
      
      status('Checking in trailer...');
      checkinBtn.disabled = true;

      const res = await api('checkin', { 
        appt, 
        org: orgInput.value.trim(), 
        token 
      });

      if (res.success) {
        checkinMessage.textContent = `${res.message || 'Check-in successful'}`;
        checkinModal.show();
        
        // Track check-in success in Statsig
        if (window.StatsigTracking && window.StatsigTracking.isInitialized()) {
          window.StatsigTracking.logEvent('checkin_completed', {
            org: orgInput.value.trim() || 'unknown',
            appointment_id: appt.AppointmentId || 'unknown',
            message: res.message || 'Check-in successful',
            timestamp: new Date().toISOString()
          });
        }
        
        findBtn.click();
      } else {
        // Track check-in failure in Statsig
        if (window.StatsigTracking && window.StatsigTracking.isInitialized()) {
          window.StatsigTracking.logEvent('checkin_failed', {
            org: orgInput.value.trim() || 'unknown',
            appointment_id: appt.AppointmentId || 'unknown',
            error: res.error || 'Check-in failed',
            timestamp: new Date().toISOString()
          });
        }
        
        // USER-FRIENDLY ERROR
        status('Check In Failed. Please see Receiving Office.', 'error');
        checkinBtn.disabled = false;
      }
    }
  </script>
  <!-- Statsig Analytics -->
  <script src="statsig.js"></script>
  <!-- Vercel Analytics -->
  <script>
    (function() {
      const script = document.createElement('script');
      script.src = '/_vercel/insights/script.js';
      script.defer = true;
      script.onerror = function() {
        console.warn('Vercel Analytics script failed to load. Make sure Analytics is enabled in Vercel dashboard and the app is redeployed.');
      };
      document.head.appendChild(script);
    })();
  </script>
</body>
</html>